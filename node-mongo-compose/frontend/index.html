<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Simple Registration</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">

        <div class="well">
            <form id="clientForm">
                <input name="id" type="hidden" />
                
                <div class="form-group">
                    <label for="name">Client Name</label>
                    <input class="form-control" name="name" placeholder="Enter name" required />
                </div>
                
                <button type="button" class="btn btn-success" save>Save</button>
            </form>
        </div>

        <table class="table table-striped" id="clients">
            <thead>
                <tr>
                    <th>Name</th> 
                    <th style="width: 30%; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="clientsRows"></tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script>
    // API Endpoint configuration
    const API = 'http://localhost:3000'

    // UI utility function
    const createButton = (label, type) => {
        return $('<button>').addClass(`btn btn-sm btn-${type}`).html(label);
    }

    // Clears the form fields
    const clearForm = () => {
        $('[name=id]').val('')
        $('[name=name]').val('')
        $('[name=name]').focus()
    }

    // Loads client data into the form
    const loadClient = client => {
        $('[name=id]').val(client._id)
        $('[name=name]').val(client.name)
        $('[name=name]').focus()
    }

    // DELETE request
    const removeClient = client => {
        if (!confirm(`Are you sure you want to remove ${client.name}?`)) {
            return;
        }
        $.ajax({
            method: 'DELETE',
            url: `${API}/clients/${client._id}`,
            success: getClients 
        })
    }
    
    const renderRows = clients => {
        const rows = clients.map(client => {
            const updateButton = createButton('Update', 'warning')
            updateButton.click(() => loadClient(client))
            
            const removeButton = createButton('Delete', 'danger')
            removeButton.click(() => removeClient(client))

            const actionContainer = $('<div>').addClass('action-buttons')
                .append(updateButton)
                .append(removeButton)

            const row = $('<tr>')
                .append($('<td>').text(client.name)) 
                .append($('<td>').append(actionContainer));
                
            row.on('mousedown', function() {
                $(this).addClass('row-active');
            }).on('mouseup mouseleave', function() {
                const $this = $(this);
                setTimeout(() => {
                    $this.removeClass('row-active');
                }, 100); 
            });

            return row;
        })

        $('#clientsRows').html(rows)
    }
    
    // GET all clients
    const getClients = () => {
        const saveButton = $('[save]');
        saveButton.removeClass('row-active'); 
        
        $.ajax({
            url: `${API}/clients`,
            success: renderRows,
            error: (xhr, status, error) => {
                console.error("Error fetching clients. Is the server running?", error);
                $('#clientsRows').html(`<tr><td colspan="2" class="text-danger" style="text-align: center;">API connection error: ${error}</td></tr>`);
            }
        })
    }

    // POST/PUT client
    const saveClient = () => {
        const _id = $('[name=id]').val()
        const name = $('[name=name]').val()
        const saveButton = $('[save]');

        if (!name.trim()) {
            alert('Name cannot be empty.')
            $('[name=name]').focus()
            return
        }

    // Save button tap feedback
        saveButton.addClass('row-active'); 
        setTimeout(() => saveButton.removeClass('row-active'), 300);

        $.ajax({
            method: _id ? 'PUT' : 'POST',
            url: _id ? `${API}/clients/${_id}` : `${API}/clients`,
            data: { name: name },
            success: () => {
                getClients() 
                clearForm()  
            },
            error: () => {
                saveButton.removeClass('row-active');
                alert('Error saving client.');
            }
        })
    }

    // Initialization
    $(() => {
        getClients()
        
        // Save button tap event handler
        $('[save]').on('mousedown', function() {
             $(this).addClass('row-active');
        }).on('mouseup mouseleave', function() {
             const $this = $(this);
             setTimeout(() => {
                 $this.removeClass('row-active');
             }, 100); 
        });

        $('[save]').click(saveClient)
    })
</script>

</body>
</html>